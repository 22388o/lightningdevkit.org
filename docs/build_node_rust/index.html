<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Lightning Dev Kit Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Lightning Dev Kit Blog Atom Feed"><title data-react-helmet="true">Building a Node with LDK in Rust | Lightning Dev Kit</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Building a Node with LDK in Rust | Lightning Dev Kit"><meta data-react-helmet="true" name="description" content="Introduction"><meta data-react-helmet="true" property="og:description" content="Introduction"><meta data-react-helmet="true" property="og:url" content="https://your-docusaurus-test-site.com/docs/build_node_rust"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://your-docusaurus-test-site.com/docs/build_node_rust"><link rel="stylesheet" href="/styles.afebabe9.css">
<link rel="preload" href="/styles.9132bff0.js" as="script">
<link rel="preload" href="/runtime~main.2ec3c334.js" as="script">
<link rel="preload" href="/main.ce7e1489.js" as="script">
<link rel="preload" href="/1.ad5cf33a.js" as="script">
<link rel="preload" href="/17.f84784bf.js" as="script">
<link rel="preload" href="/18.096b12f2.js" as="script">
<link rel="preload" href="/935f2afb.27daced0.js" as="script">
<link rel="preload" href="/16.768b6c8f.js" as="script">
<link rel="preload" href="/58be14e3.ce4b793e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">LDK</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/lightningdevkit" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">LDK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/lightningdevkit" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLinkText_yu3-">Lightning Development Kit</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/use_cases">Use Cases for LDK</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_yu3-">Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/build_node">Building a Node with LDK in Java</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/build_node_rust">Building a Node with LDK in Rust</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/using_ldk">Using LDK</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/key_mgmt">Key Management</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blockdata">Blockchain Data</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Building a Node with LDK in Rust</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h2><p>This document covers everything you need to make a node using LDK in Rust.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>For an integrated example of an LDK node in Rust, see the <a href="https://github.com/lightningdevkit/ldk-sample" target="_blank" rel="noopener noreferrer">Sample Node</a></p></div></div><ul><li><a href="#setup">Setup</a> covers everything you need to do to set up LDK on startup.</li><li><a href="#running-ldk">Running LDK</a> covers everything you need to do while LDK is running to keep it operational.</li></ul><p>Note that LDK does not assume that safe shutdown is available, so there is no
shutdown checklist.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="setup"></a>Setup<a class="hash-link" href="#setup" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="1-initialize-the-feeestimator"></a>1. Initialize the <code>FeeEstimator</code><a class="hash-link" href="#1-initialize-the-feeestimator" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> estimating fees for on-chain transactions that LDK wants broadcasted.</p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct YourFeeEstimator();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl FeeEstimator for YourFeeEstimator {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn get_est_sat_per_1000_weight(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;self, confirmation_target: ConfirmationTarget,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) -&gt; u32 {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        match confirmation_target {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ConfirmationTarget::Background =&gt; // fetch background feerate,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ConfirmationTarget::Normal =&gt; // fetch normal feerate (~6 blocks)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ConfirmationTarget::HighPriority =&gt; // fetch high priority feerate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let fee_estimator = YourFeeEstimator();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Implementation notes:</strong> </p><ol><li>Fees must be returned in: satoshis per 1000 weight units</li><li>Fees must be no smaller than 253 (equivalent to 1 satoshi/vbyte, rounded up)</li><li>To reduce network traffic, you may want to cache fee results rather than
retrieving fresh ones every time</li></ol><p><strong>Dependencies:</strong> <em>none</em></p><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/chain/chaininterface/trait.FeeEstimator.html" target="_blank" rel="noopener noreferrer"><code>FeeEstimator</code> docs</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="2-initialize-the-logger"></a>2. Initialize the <code>Logger</code><a class="hash-link" href="#2-initialize-the-logger" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> LDK logging</p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct YourLogger();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl Logger for YourLogger {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn log(&amp;self, record: &amp;Record) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let raw_log = record.args.to_string();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let log = format!(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;{} {:&lt;5} [{}:{}] {}\n&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            OffsetDateTime::now_utc().format(&quot;%F %T&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            record.level.to_string(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            record.module_path,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            record.line,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            raw_log</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // &lt;insert code to print this log and/or write this log to disk&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let logger = YourLogger();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Implementation notes:</strong> you&#x27;ll likely want to write the logs to a file for debugging purposes.</p><p><strong>Dependencies:</strong> <em>none</em></p><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/util/logger/trait.Logger.html" target="_blank" rel="noopener noreferrer"><code>Logger</code> docs</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="3-initialize-the-broadcasterinterface"></a>3. Initialize the <code>BroadcasterInterface</code><a class="hash-link" href="#3-initialize-the-broadcasterinterface" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> broadcasting various lightning transactions </p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct YourTxBroadcaster();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl BroadcasterInterface for YourTxBroadcaster {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn broadcast_transaction(&amp;self, tx: &amp;Transaction) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // &lt;insert code to broadcast this transaction&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let broadcaster = YourTxBroadcaster();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Dependencies:</strong> <em>none</em></p><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/chain/chaininterface/trait.BroadcasterInterface.html" target="_blank" rel="noopener noreferrer"><code>BroadcasterInterface</code> docs</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="4-initialize-persist"></a>4. Initialize <code>Persist</code><a class="hash-link" href="#4-initialize-persist" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> persisting <code>ChannelMonitor</code>s, which contain crucial channel data, in a timely manner</p><p><strong>Example:</strong></p><div><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_1shy tabs__item--active">Custom</li><li role="tab" tabindex="0" aria-selected="false" class="tabs__item tabItem_1shy">Using LDK Sample Filesystem Persistence Module</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct YourPersister();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl&lt;ChannelSigner: Sign&gt; Persist for YourPersister {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn persist_new_channel(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;self, funding_txo: OutPoint, monitor: &amp;ChannelMonitor&lt;ChannelSigner&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) -&gt; Result&lt;(), ChannelMonitorUpdateErr&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // &lt;insert code to persist the ChannelMonitor to disk and/or backups&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Note that monitor.encode() will get you the ChannelMonitor as a</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Vec&lt;u8&gt;.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn update_persisted_channel(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;self, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        funding_txo: OutPoint, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        update: &amp;ChannelMonitorUpdate, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        monitor: &amp;ChannelMonitor&lt;ChannelSigner&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) -&gt; Result&lt;(), ChannelMonitorUpdateErr&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // &lt;insert code to persist either the ChannelMonitor or the</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        //  ChannelMonitorUpdate to disk&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let persister = YourPersister();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div><div role="tabpanel" hidden=""><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">use lightning_persister::FilesystemPersister; // import LDK sample persist module</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let persister = FilesystemPersister::new(ldk_data_dir_path);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div></div></div><p><strong>Implementation notes:</strong> </p><ul><li><code>ChannelMonitor</code>s are objects which are capable of
responding to on-chain events for a given channel. Thus, you will have one
<code>ChannelMonitor</code> per channel. They are persisted in real-time and the <code>Persist</code>
methods will block progress on sending or receiving payments until they return.
You must ensure that <code>ChannelMonitor</code>s are durably persisted to disk before
returning or you may lose funds.</li><li>If you implement a custom persister, it&#x27;s important to read the trait docs (linked in References) to make sure you satisfy the API requirements, particularly for <code>update_persisted_channel</code></li></ul><p><strong>Dependencies:</strong> <em>none</em></p><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/chain/channelmonitor/trait.Persist.html" target="_blank" rel="noopener noreferrer"><code>Persist</code> docs</a>, <a href="https://github.com/rust-bitcoin/rust-lightning/tree/main/lightning-persister" target="_blank" rel="noopener noreferrer">Rust sample persister module</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="5-optional-initialize-the-transaction-filter"></a>5. Optional: Initialize the Transaction <code>Filter</code><a class="hash-link" href="#5-optional-initialize-the-transaction-filter" title="Direct link to heading">#</a></h3><p><strong>You must follow this step if:</strong> you are <em>not</em> providing full blocks to LDK,
i.e. if you&#x27;re using BIP 157/158 or Electrum as your chain backend</p><p><strong>What it&#x27;s used for:</strong> if you are not providing full blocks, LDK uses this
object to tell you what transactions and outputs to watch for on-chain. You&#x27;ll
inform LDK about these transactions/outputs in Step 15.</p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct YourTxFilter();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl Filter for YourTxFilter {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn register_tx(&amp;self, txid: &amp;Txid, script_pubkey: &amp;Script) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // &lt;insert code for you to watch for this transaction on-chain&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn register_output(&amp;self, output: WatchedOutput) -&gt; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Option&lt;(usize, Transaction)&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // &lt;insert code for you to watch for any transactions that spend this</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // output on-chain&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let filter = YourTxFilter();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Implementation notes:</strong> see the <a href="/docs/blockdata">Blockchain Data</a> guide for more info</p><p><strong>Dependencies:</strong> <em>none</em></p><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/chain/trait.Filter.html" target="_blank" rel="noopener noreferrer"><code>Filter</code> docs</a>, <a href="/docs/blockdata">Blockchain Data guide</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="6-initialize-the-chainmonitor"></a>6. Initialize the <code>ChainMonitor</code><a class="hash-link" href="#6-initialize-the-chainmonitor" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> tracking one or more <code>ChannelMonitor</code>s and using them to monitor the chain for lighting transactions that are relevant to our node, and broadcasting transactions if need be</p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let filter: Option&lt;Filter&gt; = // leave this as None or insert the Filter trait</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                             // object, depending on what you did for Step 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let chain_monitor = ChainMonitor::new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    filter, &amp;broadcaster, &amp;logger, &amp;fee_estimator, &amp;persister</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Implementation notes:</strong> <code>Filter</code> must be non-<code>None</code> if you&#x27;re using Electrum or BIP 157/158 as your chain backend</p><p><strong>Dependencies:</strong> <code>FeeEstimator</code>, <code>Logger</code>, <code>BroadcasterInterface</code>, <code>Persist</code></p><p><strong>Optional dependency:</strong> <code>Filter</code></p><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/chain/chainmonitor/struct.ChainMonitor.html" target="_blank" rel="noopener noreferrer"><code>ChainMonitor</code> docs</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="7-initialize-the-keysmanager"></a>7. Initialize the <code>KeysManager</code><a class="hash-link" href="#7-initialize-the-keysmanager" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> providing keys for signing lightning transactions</p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let keys_seed_path = format!(&quot;{}/keys_seed&quot;, ldk_data_dir.clone());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// If we&#x27;re restarting and already have a key seed, read it from disk. Else,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// create a new one.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let keys_seed = if let Ok(seed) = fs::read(keys_seed_path.clone()) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(seed.len(), 32);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut key = [0; 32];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    key.copy_from_slice(&amp;seed);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut key = [0; 32];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    thread_rng().fill_bytes(&amp;mut key);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    match File::create(keys_seed_path.clone()) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Ok(mut f) =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            f.write_all(&amp;key)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .expect(&quot;Failed to write node keys seed to disk&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            f.sync_all().expect(&quot;Failed to sync node keys seed to disk&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Err(e) =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            println!(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;ERROR: Unable to create keys seed file {}: {}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                keys_seed_path, e</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let cur = SystemTime::now().duration_since(SystemTime::UNIX_EPOCH).unwrap();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let keys_manager = KeysManager::new(&amp;keys_seed, cur.as_secs(), cur.subsec_nanos());</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Implementation notes:</strong></p><ul><li>See the <a href="/docs/key_mgmt">Key Management</a> guide for more info</li><li>Note that you must write the <code>key_seed</code> you give to the <code>KeysManager</code> on
startup to disk, and keep using it to initialize the <code>KeysManager</code> every time
you restart. This <code>key_seed</code> is used to derive your node&#x27;s secret key (which
corresponds to its node pubkey) and all other secret key material.</li><li>The current time is part of the <code>KeysManager</code>&#x27;s parameters because it is used to derive
random numbers from the seed where required, to ensure all random
generation is unique across restarts.</li></ul><p><strong>Dependencies:</strong> random bytes</p><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/chain/keysinterface/struct.KeysManager.html" target="_blank" rel="noopener noreferrer"><code>KeysManager</code> docs</a>, <a href="/docs/key_mgmt">Key Management guide</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="8-marshal-channelmonitors-from-disk"></a>8. Marshal <code>ChannelMonitor</code>s from disk<a class="hash-link" href="#8-marshal-channelmonitors-from-disk" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> if LDK is restarting and has at least 1 channel, its <code>ChannelMonitor</code>s will need to be (1) fed to the <code>ChannelManager</code> in Step 9 and (2) synced to chain in Step 10.</p><p><strong>Example:</strong> using LDK&#x27;s sample persistence module</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Use LDK&#x27;s sample persister module provided method</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut channel_monitors =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    persister.read_channelmonitors(keys_manager.clone()).unwrap();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// If you are using Electrum or BIP 157/158, you must call load_outputs_to_watch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// on each ChannelMonitor to prepare for chain synchronization in Step 10.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">for chan_mon in channel_monitors.iter() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    chan_mon.load_outputs_to_watch(&amp;filter);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Dependencies:</strong> <code>KeysManager</code></p><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/chain/channelmonitor/struct.ChannelMonitor.html#method.load_outputs_to_watch" target="_blank" rel="noopener noreferrer"><code>load_outputs_to_watch</code> docs</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="9-initialize-the-channelmanager"></a>9. Initialize the <code>ChannelManager</code><a class="hash-link" href="#9-initialize-the-channelmanager" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> managing channel state</p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let user_config = UserConfig::default();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/* RESTARTING */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let (channel_manager_blockhash, mut channel_manager) = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let channel_manager_file = </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        fs::File::open(format!(&quot;{}/manager&quot;, ldk_data_dir.clone())).unwrap();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Use the `ChannelMonitors` marshalled in Step 8.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut channel_monitor_mut_references = Vec::new();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (_, channel_monitor) in channel_monitors.iter_mut() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        channel_monitor_mut_references.push(channel_monitor);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let read_args = ChannelManagerReadArgs::new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;keys_manager,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;fee_estimator,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;chain_monitor,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;broadcaster,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;logger,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        user_config,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        channel_monitor_mut_references,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;(BlockHash, ChannelManager)&gt;::read(&amp;mut channel_manager_file, read_args)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .unwrap()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/* FRESH CHANNELMANAGER */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let (channel_manager_blockhash, mut channel_manager) = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let best_blockhash = // insert the best blockhash you know of</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let best_chain_height = // insert the height corresponding to best_blockhash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let chain_params = ChainParameters {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        network: Network::Testnet, // substitute this with your network</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        best_block: BestBlock::new(best_blockhash, best_chain_height),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let fresh_channel_manager = ChannelManager::new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;fee_estimator,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;chain_monitor,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;broadcaster,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;logger,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;keys_manager,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        user_config,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        chain_params,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (best_blockhash, fresh_channel_manager)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Implementation notes:</strong> No methods should be called on <code>ChannelManager</code> until
<em>after</em> Step 10.</p><p><strong>Dependencies:</strong> <code>KeysManager</code>, <code>FeeEstimator</code>, <code>ChainMonitor</code>, <code>BroadcasterInterface</code>, <code>Logger</code></p><ul><li>If restarting: <code>ChannelMonitor</code>s and <code>ChannelManager</code> bytes from Step 8 and Step 17 respectively</li></ul><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/ln/channelmanager/struct.ChannelManager.html" target="_blank" rel="noopener noreferrer"><code>ChannelManager</code> docs</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="10-sync-channelmonitors-and-channelmanager-to-chain-tip"></a>10. Sync <code>ChannelMonitor</code>s and <code>ChannelManager</code> to chain tip<a class="hash-link" href="#10-sync-channelmonitors-and-channelmanager-to-chain-tip" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> this step is only necessary if you&#x27;re restarting and have open channels. This step ensures that LDK channel state is up-to-date with the bitcoin blockchain</p><p><strong>Example:</strong></p><div><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_1shy tabs__item--active">Full Blocks or BIP 157/158</li><li role="tab" tabindex="0" aria-selected="false" class="tabs__item tabItem_1shy">Electrum</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">use lightning_block_sync::init;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use lightning_block_sync::poll;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use lightning_block_sync::UnboundedCache;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl lightning_block_sync::BlockSource for YourChainBackend {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn get_header&lt;&#x27;a&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;&#x27;a mut self, header_hash: &amp;&#x27;a BlockHash, height_hint: Option&lt;u32&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) -&gt; AsyncBlockSourceResult&lt;&#x27;a, BlockHeaderData&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // &lt;insert code to retrieve the header corresponding to header_hash&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn get_block&lt;&#x27;a&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;&#x27;a mut self, header_hash: &amp;&#x27;a BlockHash,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) -&gt; AsyncBlockSourceResult&lt;&#x27;a, Block&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // &lt;insert code to retrieve the block corresponding to header_hash&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn get_best_block&lt;&#x27;a&gt;(&amp;&#x27;a mut self) -&gt; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        AsyncBlockSourceResult&lt;(BlockHash, Option&lt;u32&gt;)&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // &lt;insert code to retrieve your best known block hash and height&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let block_source = YourChainBackend::new();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut chain_listener_channel_monitors = Vec::new();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut cache = UnboundedCache::new();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut chain_tip: Option&lt;poll::ValidatedBlockHeader&gt; = None;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut chain_listeners = vec![(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    channel_manager_blockhash,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;mut channel_manager as &amp;mut dyn chain::Listen,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">)];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">for (blockhash, channel_monitor) in channel_monitors.drain(..) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let outpoint = channel_monitor.get_funding_txo().0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    chain_listener_channel_monitors.push((</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        blockhash,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            channel_monitor,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &amp;broadcaster,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &amp;fee_estimator,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &amp;logger,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        outpoint,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">for monitor_listener_info in chain_listener_channel_monitors.iter_mut()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    chain_listeners.push((</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        monitor_listener_info.0,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;mut monitor_listener_info.1 as &amp;mut dyn chain::Listen,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Save the chain tip to be used in Step 15.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">chain_tip = Some(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    init::synchronize_listeners(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;mut block_source,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Network::Testnet,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;mut cache,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        chain_listeners,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .await</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .unwrap(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div><div role="tabpanel" hidden=""><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Retrieve transaction IDs to check the chain for un-confirmation.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let relevant_txids_1 = channel_manager.as_Confirm().get_relevant_txids();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let relevant_txids_2 = chain_monitor.as_Confirm().get_relevant_txids();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let unconfirmed_txids = // &lt;insert code to find out from your chain source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        //  if any of relevant_txids have been reorged out</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        //  of the chain&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">for txid in unconfirmed_txids.iter() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    channel_manager.transaction_unconfirmed(txid);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    chain_monitor.transaction_unconfirmed(txid);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Retrieve transactions and outputs that were registered through the `Filter`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// interface in Step 5.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// If any of these txs/outputs were confirmed on-chain, then:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let header = // insert block header from the block with confirmed tx/output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let height = // insert block height of `header`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let tx_list = // insert `Filter`-registered transactions that were confirmed in</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              // this block</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">channel_manager.transactions_confirmed(header, tx_list, height);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">chain_monitor.transactions_confirmed(header, tx_list, height);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">byte[] best_header = // &lt;insert code to get your best known header&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">int best_height = // &lt;insert code to get your best known block height&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">channel_manager.update_best_block(best_header, best_height);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">chain_monitor.update_best_block(best_header, best_height);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div></div></div><p><strong>Implementation notes:</strong></p><ul><li>There are 2 main options for synchronizing to chain on startup:<ul><li>If you are connecting full blocks or using BIP 157/158, then it is recommended to use
LDK&#x27;s <code>lightning_block_sync</code> sample module as in the example above</li><li>Otherwise, you can use LDK&#x27;s <code>Confirm</code> interface as in the Electrum example above</li></ul></li><li>More details about LDK&#x27;s interfaces to provide chain info in Step 15</li></ul><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/chain/trait.Confirm.html" target="_blank" rel="noopener noreferrer"><code>Confirm</code> docs</a>, <a href="https://docs.rs/lightning-block-sync/*/lightning_block_sync/" target="_blank" rel="noopener noreferrer">Rust <code>lightning_block_sync</code> module docs</a></p><p><strong>Dependencies:</strong> <code>ChannelManager</code></p><ul><li>If providing providing full blocks or BIP 157/158: set of <code>ChannelMonitor</code>s</li><li>If using Electrum: <code>ChainMonitor</code></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="11-give-channelmonitors-to-chainmonitor"></a>11. Give <code>ChannelMonitor</code>s to <code>ChainMonitor</code><a class="hash-link" href="#11-give-channelmonitors-to-chainmonitor" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> <code>ChainMonitor</code> is responsible for updating the <code>ChannelMonitor</code>s during LDK node operation.</p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">for (funding_outpoint, channel_monitor) in channel_monitors.drain(..) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    chain_monitor.watch_channel(funding_outpoint, channel_monitor).unwrap();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Dependencies:</strong> </p><ul><li><code>ChainMonitor</code>, set of <code>ChannelMonitor</code>s and their funding outpoints</li><li>Step 10 must be completed prior to this step</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="12-optional-initialize-the-netgraphmsghandler"></a>12. Optional: Initialize the <code>NetGraphMsgHandler</code><a class="hash-link" href="#12-optional-initialize-the-netgraphmsghandler" title="Direct link to heading">#</a></h3><p><strong>You must follow this step if:</strong> you need LDK to provide routes for sending payments (i.e. you are <em>not</em> providing your own routes)</p><p><strong>What it&#x27;s used for:</strong> generating routes to send payments over</p><p><strong>Example:</strong> initializing <code>NetGraphMsgHandler</code> without providing an <code>Access</code></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let genesis = genesis_block(Network::Testnet).header.block_hash();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let router = Arc::new(NetGraphMsgHandler::new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    genesis,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    None::&lt;Arc&lt;dyn chain::Access + Send + Sync&gt;&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;logger,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">));</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Implementation notes:</strong> this struct is not required if you are providing your own routes.</p><p><strong>Dependencies:</strong> <code>Logger</code></p><p><strong>Optional dependency:</strong> <code>Access</code>, a source of chain information. Recommended to be able to verify channels before adding them to the internal network graph.</p><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/routing/network_graph/struct.NetGraphMsgHandler.html" target="_blank" rel="noopener noreferrer"><code>NetGraphMsgHandler</code> docs</a>, <a href="https://docs.rs/lightning/*/lightning/chain/trait.Access.html" target="_blank" rel="noopener noreferrer"><code>Access</code> docs</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="13-initialize-the-peermanager"></a>13. Initialize the <code>PeerManager</code><a class="hash-link" href="#13-initialize-the-peermanager" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> managing peer data and connections</p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut ephemeral_bytes = [0; 32];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rand::thread_rng().fill_bytes(&amp;mut ephemeral_bytes);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let lightning_msg_handler = MessageHandler {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    chan_handler: &amp;channel_manager,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    route_handler: &amp;router,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let peer_manager = PeerManager::new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    lightning_msg_handler,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    keys_manager.get_node_secret(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;ephemeral_bytes,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;logger,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Implementation notes:</strong> if you did not initialize <code>NetGraphMsgHandler</code> in the previous step, you can initialize your own struct (which can be a dummy struct) that implements <code>RoutingMessageHandlerInterface</code></p><p><strong>Dependencies:</strong> <code>ChannelManager</code>, <code>RoutingMessageHandlerInterface</code>, <code>KeysManager</code>, random bytes, <code>Logger</code></p><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/ln/peer_handler/struct.PeerManager.html" target="_blank" rel="noopener noreferrer"><code>PeerManager</code> docs</a>, <a href="https://docs.rs/lightning/*/lightning/ln/msgs/trait.RoutingMessageHandler.html" target="_blank" rel="noopener noreferrer"><code>RoutingMessageHandler</code> docs</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="14-initialize-networking"></a>14. Initialize Networking<a class="hash-link" href="#14-initialize-networking" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> making peer connections, facilitating peer data to and from LDK</p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">use lightning_net_tokio; // use LDK&#x27;s sample networking module</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let listen_port = 9735;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let listener = tokio::net::TcpListener::bind(format!(&quot;0.0.0.0:{}&quot;, listen_port))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .await.unwrap()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">loop {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let tcp_stream = listener.accept().await.unwrap().0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tokio::spawn(async move {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Use LDK&#x27;s supplied networking battery to facilitate inbound</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // connections.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        lightning_net_tokio::setup_inbound(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &amp;peer_manager,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            tcp_stream.into_std().unwrap(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .await;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Dependencies:</strong> <code>PeerManager</code></p><p><strong>References:</strong> <a href="https://docs.rs/lightning-net-tokio/0.0.14/lightning_net_tokio/" target="_blank" rel="noopener noreferrer">Rust <code>lightning-net-tokio</code> sample networking module</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="running-ldk"></a>Running LDK<a class="hash-link" href="#running-ldk" title="Direct link to heading">#</a></h2><p>This section assumes you&#x27;ve already run all the steps in <a href="#setup">Setup</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="15-keep-ldk-up-to-date-with-chain-info"></a>15. Keep LDK Up-to-date with Chain Info<a class="hash-link" href="#15-keep-ldk-up-to-date-with-chain-info" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> LDK needs to know when blocks are newly connected and disconnected and when relevant transactions are confirmed and/or reorged out.</p><p><strong>Example:</strong></p><div><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_1shy tabs__item--active">Bitcoind</li><li role="tab" tabindex="0" aria-selected="false" class="tabs__item tabItem_1shy">Electrum</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// If you don&#x27;t have the chain tip, retrieve it here.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if chain_tip.is_none() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    chain_tip = Some(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        init::validate_best_block_header(&amp;mut block_source).await.unwrap()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Use your BlockSource from Step 10.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let chain_poller = poll::ChainPoller::new(&amp;mut block_source, Network::Testnet);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let chain_listener = (chain_monitor, channel_manager);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut spv_client = SpvClient::new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    chain_tip.unwrap(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    chain_poller,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;mut cache,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;chain_listener,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">loop {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // `poll_best_tip` will update ChannelManager and ChainMonitor with the</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // best chain tip as needed.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    spv_client.poll_best_tip().await.unwrap();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tokio::time::sleep(Duration::from_secs(1)).await;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div><div role="tabpanel" hidden=""><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/* UNCONFIRMED TRANSACTIONS */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Retrieve transaction IDs to check the chain for un-confirmation.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let relevant_txids_1 = channel_manager.get_relevant_txids();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let relevant_txids_2 = chain_monitor.get_relevant_txids();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// If any txids `relevant_txids_*` gets reorged out, you must call:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">channel_manager.transaction_unconfirmed(unconfirmed_txid);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">chain_monitor.transaction_unconfirmed(unconfirmed_txid);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/* CONFIRMED TRANSACTIONS */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Retrieve transactions and outputs to check the chain for confirmation.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// These should&#x27;ve been given to you for monitoring via the `Filter` interface.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// If any transactions or output spends appear on-chain, you must call:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">channel_manager.transactions_confirmed(header, height, confirmed_txs_list);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">chain_monitor.transactions_confirmed(header, height, confirmed_txs_list);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/* CONNECTED OR DISCONNECTED BLOCKS */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Whenever there&#x27;s a new chain tip or a block has been newly disconnected, you</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// must call:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">channel_manager.update_best_block(new_best_header, new_best_height);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">chain_monitor.update_best_block(new_best_header, new_best_height);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div></div></div><p><strong>Implementation notes:</strong></p><ul><li>If you&#x27;re using the <code>Listen</code> interface: blocks must be connected and disconnected in chain order</li><li>If you&#x27;re using the <code>Confirm</code> interface: it&#x27;s important to read the <code>Confirm</code> docs linked in References, to make sure you satisfy the interface&#x27;s requirements</li></ul><p><strong>Dependencies:</strong> <code>ChannelManager</code>, <code>ChainMonitor</code></p><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/chain/trait.Listen.html" target="_blank" rel="noopener noreferrer">Rust <code>Listen</code> docs</a>, <a href="https://docs.rs/lightning/*/lightning/chain/trait.Confirm.html" target="_blank" rel="noopener noreferrer">Rust <code>Confirm</code> docs</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="16-initialize-ldk-eventhandler"></a>16. Initialize LDK <code>EventHandler</code><a class="hash-link" href="#16-initialize-ldk-eventhandler" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> LDK generates events that must be handled by you, such as telling you when a payment has been successfully received or when a funding transaction is ready for broadcast.</p><p><strong>Example:</strong> from the LDK Rust sample node, of handling these events: <a href="https://github.com/lightningdevkit/ldk-sample/blob/bc07db6ca4a3323d8718a27f85182b8157a20750/src/main.rs#L101-L240" target="_blank" rel="noopener noreferrer">https://github.com/lightningdevkit/ldk-sample/blob/bc07db6ca4a3323d8718a27f85182b8157a20750/src/main.rs#L101-L240</a></p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// In this example, we provide a closure to handle events. But you&#x27;re also free</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// to provide an implementation of the trait `EventHandler` instead.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// This handler will be used in Step 18.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let handle_event_callback = move |event| {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    handle_ldk_event(&amp;channel_manager, &amp;keys_manager, event)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fn handle_ldk_event(..) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    match event {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Event::FundingGenerationReady { .. } =&gt; { .. }, // insert handling code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Event::PaymentReceived { .. } =&gt; { .. }, // insert handling code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Event::PaymentSent { .. } =&gt; { .. }, // insert handling code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Event::PaymentFailed { .. } =&gt; { .. }, // insert handling code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Event::PendingHTLCsForwardable { .. } =&gt; { .. }, // insert handling code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Event::SpendableOutputs { .. } =&gt; { .. } // insert handling code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Implementation notes:</strong> </p><ul><li>It&#x27;s important to read the documentation for individual event handling (linked in References below) to make sure event handling requirements are satisfied</li><li>It is recommended to read through event handling in the LDK sample node (linked in the first example) to get an idea of what integrated LDK event handling looks like</li></ul><p><strong>Dependencies:</strong> <code>ChannelManager</code>, <code>ChainMonitor</code>, <code>KeysManager</code>, <code>BroadcasterInterface</code></p><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/util/events/enum.Event.html" target="_blank" rel="noopener noreferrer"><code>Event</code> docs</a>, <a href="https://github.com/lightningdevkit/ldk-sample/blob/bc07db6ca4a3323d8718a27f85182b8157a20750/src/main.rs#L101-L240" target="_blank" rel="noopener noreferrer">LDK sample node event handling example</a>, <a href="https://docs.rs/lightning/*/lightning/util/events/trait.EventHandler.html" target="_blank" rel="noopener noreferrer"><code>EventHandler</code> docs</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="17-initialize-the-channelmanagerpersister"></a>17. Initialize the <code>ChannelManagerPersister</code><a class="hash-link" href="#17-initialize-the-channelmanagerpersister" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> keeping <code>ChannelManager</code>&#x27;s stored state up-to-date</p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// In this example, we provide a closure to handle ChannelManager persistence.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// But you&#x27;re also free to provide an implementation of the trait </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// `ChannelManagerPersister` instead.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// This callback will be used in the Step 18 for regular persistence.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let persist_channel_manager_callback = move |node: &amp;ChannelManager| {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    FilesystemPersister::persist_manager(ldk_data_dir, &amp;*node)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Implementation notes:</strong> if the <code>ChannelManager</code> is not persisted properly to disk, there is risk of channels force closing the next time LDK starts up. However, in this situation, no funds other than those used to pay force-closed channel fees are at risk of being lost.</p><p><strong>Dependencies:</strong> <code>ChannelManager</code></p><p><strong>References:</strong> <a href="https://docs.rs/lightning-background-processor/*/lightning_background_processor/trait.ChannelManagerPersister.html" target="_blank" rel="noopener noreferrer"><code>ChannelManagerPersister</code> docs</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="18-start-background-processing"></a>18. Start Background Processing<a class="hash-link" href="#18-start-background-processing" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> running tasks periodically in the background to keep LDK operational</p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">BackgroundProcessor::start(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    persist_channel_manager_callback,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    handle_event_callback,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;chain_monitor,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;channel_manager,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;peer_manager,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;logger,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Dependencies:</strong> <code>ChannelManager</code>, <code>ChainMonitor</code>, <code>PeerManager</code>, <code>Logger</code></p><p><strong>References:</strong> <a href="https://docs.rs/lightning-background-processor/*/lightning_background_processor/struct.BackgroundProcessor.html#method.start" target="_blank" rel="noopener noreferrer"><code>BackgroundProcessor::start</code> docs</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="19-regularly-broadcast-node-announcement"></a>19. Regularly Broadcast Node Announcement<a class="hash-link" href="#19-regularly-broadcast-node-announcement" title="Direct link to heading">#</a></h3><p><strong>What it&#x27;s used for:</strong> if you have 1 or more public channels, you may need to
announce your node and its channels occasionally. LDK will automatically
announce channels when they are created, but there are no guarantees you have
connected peers at that time or that your peers will propagate such announcements.
The broader node-announcement message is not automatically broadcast.</p><p><strong>Example:</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut interval = tokio::time::interval(Duration::from_secs(60));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">loop {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    interval.tick().await;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    channel_manager.broadcast_node_announcement(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [0; 3], // insert your node&#x27;s RGB color</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        node_alias,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        vec![ldk_announced_listen_addr],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Dependencies:</strong> <code>ChannelManager</code></p><p><strong>References:</strong> <a href="https://docs.rs/lightning/*/lightning/ln/channelmanager/struct.ChannelManager.html#method.broadcast_node_announcement" target="_blank" rel="noopener noreferrer"><code>ChannelManager::broadcast_node_announcement</code> docs</a></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/lightningdevkit/lightningdevkit.org/tree/main/docs/build_node_rust.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/build_node"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Building a Node with LDK in Java</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/using_ldk"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Using LDK Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link">Introduction</a></li><li><a href="#setup" class="table-of-contents__link">Setup</a><ul><li><a href="#1-initialize-the-feeestimator" class="table-of-contents__link">1. Initialize the <code>FeeEstimator</code></a></li><li><a href="#2-initialize-the-logger" class="table-of-contents__link">2. Initialize the <code>Logger</code></a></li><li><a href="#3-initialize-the-broadcasterinterface" class="table-of-contents__link">3. Initialize the <code>BroadcasterInterface</code></a></li><li><a href="#4-initialize-persist" class="table-of-contents__link">4. Initialize <code>Persist</code></a></li><li><a href="#5-optional-initialize-the-transaction-filter" class="table-of-contents__link">5. Optional: Initialize the Transaction <code>Filter</code></a></li><li><a href="#6-initialize-the-chainmonitor" class="table-of-contents__link">6. Initialize the <code>ChainMonitor</code></a></li><li><a href="#7-initialize-the-keysmanager" class="table-of-contents__link">7. Initialize the <code>KeysManager</code></a></li><li><a href="#8-marshal-channelmonitors-from-disk" class="table-of-contents__link">8. Marshal <code>ChannelMonitor</code>s from disk</a></li><li><a href="#9-initialize-the-channelmanager" class="table-of-contents__link">9. Initialize the <code>ChannelManager</code></a></li><li><a href="#10-sync-channelmonitors-and-channelmanager-to-chain-tip" class="table-of-contents__link">10. Sync <code>ChannelMonitor</code>s and <code>ChannelManager</code> to chain tip</a></li><li><a href="#11-give-channelmonitors-to-chainmonitor" class="table-of-contents__link">11. Give <code>ChannelMonitor</code>s to <code>ChainMonitor</code></a></li><li><a href="#12-optional-initialize-the-netgraphmsghandler" class="table-of-contents__link">12. Optional: Initialize the <code>NetGraphMsgHandler</code></a></li><li><a href="#13-initialize-the-peermanager" class="table-of-contents__link">13. Initialize the <code>PeerManager</code></a></li><li><a href="#14-initialize-networking" class="table-of-contents__link">14. Initialize Networking</a></li></ul></li><li><a href="#running-ldk" class="table-of-contents__link">Running LDK</a><ul><li><a href="#15-keep-ldk-up-to-date-with-chain-info" class="table-of-contents__link">15. Keep LDK Up-to-date with Chain Info</a></li><li><a href="#16-initialize-ldk-eventhandler" class="table-of-contents__link">16. Initialize LDK <code>EventHandler</code></a></li><li><a href="#17-initialize-the-channelmanagerpersister" class="table-of-contents__link">17. Initialize the <code>ChannelManagerPersister</code></a></li><li><a href="#18-start-background-processing" class="table-of-contents__link">18. Start Background Processing</a></li><li><a href="#19-regularly-broadcast-node-announcement" class="table-of-contents__link">19. Regularly Broadcast Node Announcement</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/use_cases/">Use Cases</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/lightningdevkit/shared_invite/zt-r5p7hfz6-QNIACPbMA0e6kSGpYsKv2g" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/lightningdevkit" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 LDK Developers</div></div></div></footer></div>
<script src="/styles.9132bff0.js"></script>
<script src="/runtime~main.2ec3c334.js"></script>
<script src="/main.ce7e1489.js"></script>
<script src="/1.ad5cf33a.js"></script>
<script src="/17.f84784bf.js"></script>
<script src="/18.096b12f2.js"></script>
<script src="/935f2afb.27daced0.js"></script>
<script src="/16.768b6c8f.js"></script>
<script src="/58be14e3.ce4b793e.js"></script>
</body>
</html>