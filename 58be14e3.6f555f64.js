(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{79:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return c})),t.d(n,"metadata",(function(){return s})),t.d(n,"toc",(function(){return b})),t.d(n,"default",(function(){return d}));var a=t(3),r=t(7),i=(t(0),t(88)),o=t(96),l=t(97),c={id:"build_node_rust",title:"Building a Node with LDK in Rust"},s={unversionedId:"build_node_rust",id:"build_node_rust",isDocsHomePage:!1,title:"Building a Node with LDK in Rust",description:"Introduction",source:"@site/docs/build_node_rust.md",slug:"/build_node_rust",permalink:"/docs/build_node_rust",editUrl:"https://github.com/lightningdevkit/lightningdevkit.org/tree/main/docs/build_node_rust.md",version:"current",sidebar:"someSidebar",previous:{title:"Building a Node with LDK in Java",permalink:"/docs/build_node"},next:{title:"Using LDK",permalink:"/docs/using_ldk"}},b=[{value:"Introduction",id:"introduction",children:[]},{value:"Setup",id:"setup",children:[{value:"1. Initialize the <code>FeeEstimator</code>",id:"1-initialize-the-feeestimator",children:[]},{value:"2. Initialize the <code>Logger</code>",id:"2-initialize-the-logger",children:[]},{value:"3. Initialize the <code>BroadcasterInterface</code>",id:"3-initialize-the-broadcasterinterface",children:[]},{value:"4. Initialize <code>Persist</code>",id:"4-initialize-persist",children:[]},{value:"5. Optional: Initialize the Transaction <code>Filter</code>",id:"5-optional-initialize-the-transaction-filter",children:[]},{value:"6. Initialize the <code>ChainMonitor</code>",id:"6-initialize-the-chainmonitor",children:[]},{value:"7. Initialize the <code>KeysManager</code>",id:"7-initialize-the-keysmanager",children:[]},{value:"8. Marshal <code>ChannelMonitor</code>s from disk",id:"8-marshal-channelmonitors-from-disk",children:[]},{value:"9. Initialize the <code>ChannelManager</code>",id:"9-initialize-the-channelmanager",children:[]},{value:"10. Sync <code>ChannelMonitor</code>s and <code>ChannelManager</code> to chain tip",id:"10-sync-channelmonitors-and-channelmanager-to-chain-tip",children:[]},{value:"11. Give <code>ChannelMonitor</code>s to <code>ChainMonitor</code>",id:"11-give-channelmonitors-to-chainmonitor",children:[]},{value:"12. Optional: Initialize the <code>NetGraphMsgHandler</code>",id:"12-optional-initialize-the-netgraphmsghandler",children:[]},{value:"13. Initialize the <code>PeerManager</code>",id:"13-initialize-the-peermanager",children:[]},{value:"14. Initialize Networking",id:"14-initialize-networking",children:[]}]},{value:"Running LDK",id:"running-ldk",children:[{value:"15. Keep LDK Up-to-date with Chain Info",id:"15-keep-ldk-up-to-date-with-chain-info",children:[]},{value:"16. Initialize LDK <code>EventHandler</code>",id:"16-initialize-ldk-eventhandler",children:[]},{value:"17. Initialize the <code>ChannelManagerPersister</code>",id:"17-initialize-the-channelmanagerpersister",children:[]},{value:"18. Start Background Processing",id:"18-start-background-processing",children:[]},{value:"19. Regularly Broadcast Node Announcement",id:"19-regularly-broadcast-node-announcement",children:[]}]}],p={toc:b};function d(e){var n=e.components,t=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},p,t,{components:n,mdxType:"MDXLayout"}),Object(i.b)("h2",{id:"introduction"},"Introduction"),Object(i.b)("p",null,"This document covers everything you need to make a node using LDK in Rust."),Object(i.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(i.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"For an integrated example of an LDK node in Rust, see the ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/lightningdevkit/ldk-sample"}),"Sample Node")))),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#setup"}),"Setup")," covers everything you need to do to set up LDK on startup."),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#running-ldk"}),"Running LDK")," covers everything you need to do while LDK is running to keep it operational.")),Object(i.b)("p",null,"Note that LDK does not assume that safe shutdown is available, so there is no\nshutdown checklist."),Object(i.b)("h2",{id:"setup"},"Setup"),Object(i.b)("h3",{id:"1-initialize-the-feeestimator"},"1. Initialize the ",Object(i.b)("inlineCode",{parentName:"h3"},"FeeEstimator")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," estimating fees for on-chain transactions that LDK wants broadcasted."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"struct YourFeeEstimator();\n\nimpl FeeEstimator for YourFeeEstimator {\n    fn get_est_sat_per_1000_weight(\n        &self, confirmation_target: ConfirmationTarget,\n    ) -> u32 {\n        match confirmation_target {\n            ConfirmationTarget::Background => // fetch background feerate,\n            ConfirmationTarget::Normal => // fetch normal feerate (~6 blocks)\n            ConfirmationTarget::HighPriority => // fetch high priority feerate\n        }\n    }\n}\n\nlet fee_estimator = YourFeeEstimator();\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Implementation notes:")," "),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Fees must be returned in: satoshis per 1000 weight units"),Object(i.b)("li",{parentName:"ol"},"Fees must be no smaller than 253 (equivalent to 1 satoshi/vbyte, rounded up)"),Object(i.b)("li",{parentName:"ol"},"To reduce network traffic, you may want to cache fee results rather than\nretrieving fresh ones every time")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("em",{parentName:"p"},"none")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/chain/chaininterface/trait.FeeEstimator.html"}),Object(i.b)("inlineCode",{parentName:"a"},"FeeEstimator")," docs")),Object(i.b)("h3",{id:"2-initialize-the-logger"},"2. Initialize the ",Object(i.b)("inlineCode",{parentName:"h3"},"Logger")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," LDK logging"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),'struct YourLogger();\n\nimpl Logger for YourLogger {\n    fn log(&self, record: &Record) {\n        let raw_log = record.args.to_string();\n        let log = format!(\n            "{} {:<5} [{}:{}] {}\\n",\n            OffsetDateTime::now_utc().format("%F %T"),\n            record.level.to_string(),\n            record.module_path,\n            record.line,\n            raw_log\n        );\n        // <insert code to print this log and/or write this log to disk>\n    }\n}\n\nlet logger = YourLogger();\n')),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Implementation notes:")," you'll likely want to write the logs to a file for debugging purposes."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("em",{parentName:"p"},"none")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/util/logger/trait.Logger.html"}),Object(i.b)("inlineCode",{parentName:"a"},"Logger")," docs")),Object(i.b)("h3",{id:"3-initialize-the-broadcasterinterface"},"3. Initialize the ",Object(i.b)("inlineCode",{parentName:"h3"},"BroadcasterInterface")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," broadcasting various lightning transactions "),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"struct YourTxBroadcaster();\n\nimpl BroadcasterInterface for YourTxBroadcaster {\n    fn broadcast_transaction(&self, tx: &Transaction) {\n        // <insert code to broadcast this transaction>\n    }\n}\n\nlet broadcaster = YourTxBroadcaster();\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("em",{parentName:"p"},"none")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/chain/chaininterface/trait.BroadcasterInterface.html"}),Object(i.b)("inlineCode",{parentName:"a"},"BroadcasterInterface")," docs")),Object(i.b)("h3",{id:"4-initialize-persist"},"4. Initialize ",Object(i.b)("inlineCode",{parentName:"h3"},"Persist")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," persisting ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelMonitor"),"s, which contain crucial channel data, in a timely manner"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)(o.a,{defaultValue:"custom",values:[{label:"Custom",value:"custom"},{label:"Using LDK Sample Filesystem Persistence Module",value:"ldk-sample"}],mdxType:"Tabs"},Object(i.b)(l.a,{value:"custom",mdxType:"TabItem"},Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"struct YourPersister();\n\nimpl<ChannelSigner: Sign> Persist for YourPersister {\n    fn persist_new_channel(\n        &self, funding_txo: OutPoint, monitor: &ChannelMonitor<ChannelSigner>\n    ) -> Result<(), ChannelMonitorUpdateErr> {\n        // <insert code to persist the ChannelMonitor to disk and/or backups>\n        // Note that monitor.encode() will get you the ChannelMonitor as a\n        // Vec<u8>.\n    }\n    \n    fn update_persisted_channel(\n        &self, \n        funding_txo: OutPoint, \n        update: &ChannelMonitorUpdate, \n        monitor: &ChannelMonitor<ChannelSigner>\n    ) -> Result<(), ChannelMonitorUpdateErr> {\n        // <insert code to persist either the ChannelMonitor or the\n        //  ChannelMonitorUpdate to disk>\n    }\n}\n\nlet persister = YourPersister();\n"))),Object(i.b)(l.a,{value:"ldk-sample",mdxType:"TabItem"},Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"use lightning_persister::FilesystemPersister; // import LDK sample persist module\n\nlet persister = FilesystemPersister::new(ldk_data_dir_path);\n")))),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Implementation notes:")," "),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"ChannelMonitor"),"s are objects which are capable of\nresponding to on-chain events for a given channel. Thus, you will have one\n",Object(i.b)("inlineCode",{parentName:"li"},"ChannelMonitor")," per channel. They are persisted in real-time and the ",Object(i.b)("inlineCode",{parentName:"li"},"Persist"),"\nmethods will block progress on sending or receiving payments until they return.\nYou must ensure that ",Object(i.b)("inlineCode",{parentName:"li"},"ChannelMonitor"),"s are durably persisted to disk before\nreturning or you may lose funds."),Object(i.b)("li",{parentName:"ul"},"If you implement a custom persister, it's important to read the trait docs (linked in References) to make sure you satisfy the API requirements, particularly for ",Object(i.b)("inlineCode",{parentName:"li"},"update_persisted_channel"))),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("em",{parentName:"p"},"none")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/chain/channelmonitor/trait.Persist.html"}),Object(i.b)("inlineCode",{parentName:"a"},"Persist")," docs"),", ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/rust-bitcoin/rust-lightning/tree/main/lightning-persister"}),"Rust sample persister module")),Object(i.b)("h3",{id:"5-optional-initialize-the-transaction-filter"},"5. Optional: Initialize the Transaction ",Object(i.b)("inlineCode",{parentName:"h3"},"Filter")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"You must follow this step if:")," you are ",Object(i.b)("em",{parentName:"p"},"not")," providing full blocks to LDK,\ni.e. if you're using BIP 157/158 or Electrum as your chain backend"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," if you are not providing full blocks, LDK uses this\nobject to tell you what transactions and outputs to watch for on-chain. You'll\ninform LDK about these transactions/outputs in Step 15."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"struct YourTxFilter();\n\nimpl Filter for YourTxFilter {\n    fn register_tx(&self, txid: &Txid, script_pubkey: &Script) {\n        // <insert code for you to watch for this transaction on-chain>\n    }\n    \n    fn register_output(&self, output: WatchedOutput) -> \n        Option<(usize, Transaction)> {\n\n        // <insert code for you to watch for any transactions that spend this\n        // output on-chain>\n    }\n}\n\nlet filter = YourTxFilter();\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Implementation notes:")," see the ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/blockdata"}),"Blockchain Data")," guide for more info"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("em",{parentName:"p"},"none")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/chain/trait.Filter.html"}),Object(i.b)("inlineCode",{parentName:"a"},"Filter")," docs"),", ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/blockdata"}),"Blockchain Data guide")),Object(i.b)("h3",{id:"6-initialize-the-chainmonitor"},"6. Initialize the ",Object(i.b)("inlineCode",{parentName:"h3"},"ChainMonitor")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," tracking one or more ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelMonitor"),"s and using them to monitor the chain for lighting transactions that are relevant to our node, and broadcasting transactions if need be"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"let filter: Option<Box<dyn Filter>> = // leave this as None or insert the Filter trait\n                                      // object, depending on what you did for Step 5\n\nlet chain_monitor = ChainMonitor::new(\n    filter, &broadcaster, &logger, &fee_estimator, &persister\n);\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Implementation notes:")," ",Object(i.b)("inlineCode",{parentName:"p"},"Filter")," must be non-",Object(i.b)("inlineCode",{parentName:"p"},"None")," if you're using Electrum or BIP 157/158 as your chain backend"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("inlineCode",{parentName:"p"},"FeeEstimator"),", ",Object(i.b)("inlineCode",{parentName:"p"},"Logger"),", ",Object(i.b)("inlineCode",{parentName:"p"},"BroadcasterInterface"),", ",Object(i.b)("inlineCode",{parentName:"p"},"Persist")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Optional dependency:")," ",Object(i.b)("inlineCode",{parentName:"p"},"Filter")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/chain/chainmonitor/struct.ChainMonitor.html"}),Object(i.b)("inlineCode",{parentName:"a"},"ChainMonitor")," docs")),Object(i.b)("h3",{id:"7-initialize-the-keysmanager"},"7. Initialize the ",Object(i.b)("inlineCode",{parentName:"h3"},"KeysManager")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," providing keys for signing lightning transactions"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),'let keys_seed_path = format!("{}/keys_seed", ldk_data_dir.clone());\n\n// If we\'re restarting and already have a key seed, read it from disk. Else,\n// create a new one.\nlet keys_seed = if let Ok(seed) = fs::read(keys_seed_path.clone()) {\n    assert_eq!(seed.len(), 32);\n    let mut key = [0; 32];\n    key.copy_from_slice(&seed);\n    key\n} else {\n    let mut key = [0; 32];\n    thread_rng().fill_bytes(&mut key);\n    match File::create(keys_seed_path.clone()) {\n        Ok(mut f) => {\n            f.write_all(&key)\n                .expect("Failed to write node keys seed to disk");\n            f.sync_all().expect("Failed to sync node keys seed to disk");\n        }\n        Err(e) => {\n            println!(\n                "ERROR: Unable to create keys seed file {}: {}",\n                keys_seed_path, e\n            );\n            return;\n        }\n    }\n    key\n};\nlet cur = SystemTime::now().duration_since(SystemTime::UNIX_EPOCH).unwrap();\nlet keys_manager = KeysManager::new(&keys_seed, cur.as_secs(), cur.subsec_nanos());\n')),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Implementation notes:")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"See the ",Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"/docs/key_mgmt"}),"Key Management")," guide for more info"),Object(i.b)("li",{parentName:"ul"},"Note that you must write the ",Object(i.b)("inlineCode",{parentName:"li"},"key_seed")," you give to the ",Object(i.b)("inlineCode",{parentName:"li"},"KeysManager")," on\nstartup to disk, and keep using it to initialize the ",Object(i.b)("inlineCode",{parentName:"li"},"KeysManager")," every time\nyou restart. This ",Object(i.b)("inlineCode",{parentName:"li"},"key_seed")," is used to derive your node's secret key (which\ncorresponds to its node pubkey) and all other secret key material."),Object(i.b)("li",{parentName:"ul"},"The current time is part of the ",Object(i.b)("inlineCode",{parentName:"li"},"KeysManager"),"'s parameters because it is used to derive\nrandom numbers from the seed where required, to ensure all random\ngeneration is unique across restarts.")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," random bytes"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/chain/keysinterface/struct.KeysManager.html"}),Object(i.b)("inlineCode",{parentName:"a"},"KeysManager")," docs"),", ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/key_mgmt"}),"Key Management guide")),Object(i.b)("h3",{id:"8-marshal-channelmonitors-from-disk"},"8. Marshal ",Object(i.b)("inlineCode",{parentName:"h3"},"ChannelMonitor"),"s from disk"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," if LDK is restarting and has at least 1 channel, its ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelMonitor"),"s will need to be (1) fed to the ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelManager")," in Step 9 and (2) synced to chain in Step 10."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")," using LDK's sample persistence module"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"// Use LDK's sample persister module provided method\nlet mut channel_monitors =\n    persister.read_channelmonitors(keys_manager.clone()).unwrap();\n    \n// If you are using Electrum or BIP 157/158, you must call load_outputs_to_watch\n// on each ChannelMonitor to prepare for chain synchronization in Step 10.\nfor chan_mon in channel_monitors.iter() {\n    chan_mon.load_outputs_to_watch(&filter);\n}\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("inlineCode",{parentName:"p"},"KeysManager")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/chain/channelmonitor/struct.ChannelMonitor.html#method.load_outputs_to_watch"}),Object(i.b)("inlineCode",{parentName:"a"},"load_outputs_to_watch")," docs")),Object(i.b)("h3",{id:"9-initialize-the-channelmanager"},"9. Initialize the ",Object(i.b)("inlineCode",{parentName:"h3"},"ChannelManager")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," managing channel state"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),'let user_config = UserConfig::default();\n\n/* RESTARTING */\n\nlet (channel_manager_blockhash, mut channel_manager) = {\n    let channel_manager_file = \n        fs::File::open(format!("{}/manager", ldk_data_dir.clone())).unwrap();\n\n    // Use the `ChannelMonitors` marshalled in Step 8.\n    let mut channel_monitor_mut_references = Vec::new();\n    for (_, channel_monitor) in channel_monitors.iter_mut() {\n        channel_monitor_mut_references.push(channel_monitor);\n    }\n    let read_args = ChannelManagerReadArgs::new(\n        &keys_manager,\n        &fee_estimator,\n        &chain_monitor,\n        &broadcaster,\n        &logger,\n        user_config,\n        channel_monitor_mut_references,\n    );\n    <(BlockHash, ChannelManager)>::read(&mut channel_manager_file, read_args)\n        .unwrap()\n};\n\n/* FRESH CHANNELMANAGER */\n\nlet (channel_manager_blockhash, mut channel_manager) = {\n    let best_blockhash = // insert the best blockhash you know of\n    let best_chain_height = // insert the height corresponding to best_blockhash\n    let chain_params = ChainParameters {\n        network: Network::Testnet, // substitute this with your network\n        best_block: BestBlock::new(best_blockhash, best_chain_height),\n    };\n    let fresh_channel_manager = ChannelManager::new(\n        &fee_estimator,\n        &chain_monitor,\n        &broadcaster,\n        &logger,\n        &keys_manager,\n        user_config,\n        chain_params,\n    );\n    (best_blockhash, fresh_channel_manager)\n};\n')),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Implementation notes:")," No methods should be called on ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelManager")," until\n",Object(i.b)("em",{parentName:"p"},"after")," Step 10."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("inlineCode",{parentName:"p"},"KeysManager"),", ",Object(i.b)("inlineCode",{parentName:"p"},"FeeEstimator"),", ",Object(i.b)("inlineCode",{parentName:"p"},"ChainMonitor"),", ",Object(i.b)("inlineCode",{parentName:"p"},"BroadcasterInterface"),", ",Object(i.b)("inlineCode",{parentName:"p"},"Logger")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"If restarting: ",Object(i.b)("inlineCode",{parentName:"li"},"ChannelMonitor"),"s and ",Object(i.b)("inlineCode",{parentName:"li"},"ChannelManager")," bytes from Step 8 and Step 17 respectively")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/ln/channelmanager/struct.ChannelManager.html"}),Object(i.b)("inlineCode",{parentName:"a"},"ChannelManager")," docs")),Object(i.b)("h3",{id:"10-sync-channelmonitors-and-channelmanager-to-chain-tip"},"10. Sync ",Object(i.b)("inlineCode",{parentName:"h3"},"ChannelMonitor"),"s and ",Object(i.b)("inlineCode",{parentName:"h3"},"ChannelManager")," to chain tip"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," this step is only necessary if you're restarting and have open channels. This step ensures that LDK channel state is up-to-date with the bitcoin blockchain"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)(o.a,{defaultValue:"bitcoind",values:[{label:"Full Blocks or BIP 157/158",value:"bitcoind"},{label:"Electrum",value:"electrum"}],mdxType:"Tabs"},Object(i.b)(l.a,{value:"bitcoind",mdxType:"TabItem"},Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"use lightning_block_sync::init;\nuse lightning_block_sync::poll;\nuse lightning_block_sync::UnboundedCache;\n\nimpl lightning_block_sync::BlockSource for YourChainBackend {\n    fn get_header<'a>(\n        &'a mut self, header_hash: &'a BlockHash, height_hint: Option<u32>,\n    ) -> AsyncBlockSourceResult<'a, BlockHeaderData> {\n        // <insert code to retrieve the header corresponding to header_hash>\n    }\n\n    fn get_block<'a>(\n        &'a mut self, header_hash: &'a BlockHash,\n    ) -> AsyncBlockSourceResult<'a, Block> {\n        // <insert code to retrieve the block corresponding to header_hash>\n    }\n    \n    fn get_best_block<'a>(&'a mut self) -> \n        AsyncBlockSourceResult<(BlockHash, Option<u32>)> {\n        // <insert code to retrieve your best known block hash and height>\n    }\n}\n\nlet block_source = YourChainBackend::new();\n\nlet mut chain_listener_channel_monitors = Vec::new();\nlet mut cache = UnboundedCache::new();\nlet mut chain_tip: Option<poll::ValidatedBlockHeader> = None;\nlet mut chain_listeners = vec![(\n    channel_manager_blockhash,\n    &mut channel_manager as &mut dyn chain::Listen,\n)];\n\nfor (blockhash, channel_monitor) in channel_monitors.drain(..) {\n    let outpoint = channel_monitor.get_funding_txo().0;\n    chain_listener_channel_monitors.push((\n        blockhash,\n        (\n            channel_monitor,\n            &broadcaster,\n            &fee_estimator,\n            &logger,\n        ),\n        outpoint,\n    ));\n}\n\nfor monitor_listener_info in chain_listener_channel_monitors.iter_mut()\n{\n    chain_listeners.push((\n        monitor_listener_info.0,\n        &mut monitor_listener_info.1 as &mut dyn chain::Listen,\n    ));\n}\n\n// Save the chain tip to be used in Step 15.\nchain_tip = Some(\n    init::synchronize_listeners(\n        &mut block_source,\n        Network::Testnet,\n        &mut cache,\n        chain_listeners,\n    )\n    .await\n    .unwrap(),\n);\n"))),Object(i.b)(l.a,{value:"electrum",mdxType:"TabItem"},Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"// Retrieve transaction IDs to check the chain for un-confirmation.\nlet relevant_txids_1 = channel_manager.as_Confirm().get_relevant_txids();\nlet relevant_txids_2 = chain_monitor.as_Confirm().get_relevant_txids();\n\nlet unconfirmed_txids = // <insert code to find out from your chain source\n                        //  if any of relevant_txids have been reorged out\n                        //  of the chain>\n\nfor txid in unconfirmed_txids.iter() {\n    channel_manager.transaction_unconfirmed(txid);\n    chain_monitor.transaction_unconfirmed(txid);\n}\n\n// Retrieve transactions and outputs that were registered through the `Filter`\n// interface in Step 5.\n\n// If any of these txs/outputs were confirmed on-chain, then:\nlet header = // insert block header from the block with confirmed tx/output\nlet height = // insert block height of `header`\nlet tx_list = // insert `Filter`-registered transactions that were confirmed in\n              // this block\n\nchannel_manager.transactions_confirmed(header, tx_list, height);\nchain_monitor.transactions_confirmed(header, tx_list, height);\n\nbyte[] best_header = // <insert code to get your best known header>\nint best_height = // <insert code to get your best known block height>\nchannel_manager.update_best_block(best_header, best_height);\nchain_monitor.update_best_block(best_header, best_height);\n")))),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Implementation notes:")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"There are 2 main options for synchronizing to chain on startup:",Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},"If you are connecting full blocks or using BIP 157/158, then it is recommended to use\nLDK's ",Object(i.b)("inlineCode",{parentName:"li"},"lightning_block_sync")," sample module as in the example above"),Object(i.b)("li",{parentName:"ul"},"Otherwise, you can use LDK's ",Object(i.b)("inlineCode",{parentName:"li"},"Confirm")," interface as in the Electrum example above"))),Object(i.b)("li",{parentName:"ul"},"More details about LDK's interfaces to provide chain info in Step 15")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/chain/trait.Confirm.html"}),Object(i.b)("inlineCode",{parentName:"a"},"Confirm")," docs"),", ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning-block-sync/*/lightning_block_sync/"}),"Rust ",Object(i.b)("inlineCode",{parentName:"a"},"lightning_block_sync")," module docs")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelManager")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"If providing providing full blocks or BIP 157/158: set of ",Object(i.b)("inlineCode",{parentName:"li"},"ChannelMonitor"),"s"),Object(i.b)("li",{parentName:"ul"},"If using Electrum: ",Object(i.b)("inlineCode",{parentName:"li"},"ChainMonitor"))),Object(i.b)("h3",{id:"11-give-channelmonitors-to-chainmonitor"},"11. Give ",Object(i.b)("inlineCode",{parentName:"h3"},"ChannelMonitor"),"s to ",Object(i.b)("inlineCode",{parentName:"h3"},"ChainMonitor")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," ",Object(i.b)("inlineCode",{parentName:"p"},"ChainMonitor")," is responsible for updating the ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelMonitor"),"s during LDK node operation."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"for (funding_outpoint, channel_monitor) in channel_monitors.drain(..) {\n    chain_monitor.watch_channel(funding_outpoint, channel_monitor).unwrap();\n}\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," "),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"ChainMonitor"),", set of ",Object(i.b)("inlineCode",{parentName:"li"},"ChannelMonitor"),"s and their funding outpoints"),Object(i.b)("li",{parentName:"ul"},"Step 10 must be completed prior to this step")),Object(i.b)("h3",{id:"12-optional-initialize-the-netgraphmsghandler"},"12. Optional: Initialize the ",Object(i.b)("inlineCode",{parentName:"h3"},"NetGraphMsgHandler")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"You must follow this step if:")," you need LDK to provide routes for sending payments (i.e. you are ",Object(i.b)("em",{parentName:"p"},"not")," providing your own routes)"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," generating routes to send payments over"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")," initializing ",Object(i.b)("inlineCode",{parentName:"p"},"NetGraphMsgHandler")," without providing an ",Object(i.b)("inlineCode",{parentName:"p"},"Access")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"let genesis = genesis_block(Network::Testnet).header.block_hash();\nlet router = Arc::new(NetGraphMsgHandler::new(\n    genesis,\n    None::<Arc<dyn chain::Access + Send + Sync>>,\n    &logger,\n));\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Implementation notes:")," this struct is not required if you are providing your own routes."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("inlineCode",{parentName:"p"},"Logger")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Optional dependency:")," ",Object(i.b)("inlineCode",{parentName:"p"},"Access"),", a source of chain information. Recommended to be able to verify channels before adding them to the internal network graph."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/routing/network_graph/struct.NetGraphMsgHandler.html"}),Object(i.b)("inlineCode",{parentName:"a"},"NetGraphMsgHandler")," docs"),", ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/chain/trait.Access.html"}),Object(i.b)("inlineCode",{parentName:"a"},"Access")," docs")),Object(i.b)("h3",{id:"13-initialize-the-peermanager"},"13. Initialize the ",Object(i.b)("inlineCode",{parentName:"h3"},"PeerManager")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," managing peer data and connections"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"let mut ephemeral_bytes = [0; 32];\nrand::thread_rng().fill_bytes(&mut ephemeral_bytes);\nlet lightning_msg_handler = MessageHandler {\n    chan_handler: &channel_manager,\n    route_handler: &router,\n};\nlet ignoring_custom_msg_handler = IgnoringMessageHandler {};\nlet peer_manager = PeerManager::new(\n    lightning_msg_handler,\n    keys_manager.get_node_secret(),\n    &ephemeral_bytes,\n    &logger,\n    &ignoring_custom_msg_handler,\n);\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Implementation notes:")," if you did not initialize ",Object(i.b)("inlineCode",{parentName:"p"},"NetGraphMsgHandler")," in the previous step, you can initialize your own struct (which can be a dummy struct) that implements ",Object(i.b)("inlineCode",{parentName:"p"},"RoutingMessageHandlerInterface")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelManager"),", ",Object(i.b)("inlineCode",{parentName:"p"},"RoutingMessageHandlerInterface"),", ",Object(i.b)("inlineCode",{parentName:"p"},"KeysManager"),", random bytes, ",Object(i.b)("inlineCode",{parentName:"p"},"Logger")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/ln/peer_handler/struct.PeerManager.html"}),Object(i.b)("inlineCode",{parentName:"a"},"PeerManager")," docs"),", ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/ln/msgs/trait.RoutingMessageHandler.html"}),Object(i.b)("inlineCode",{parentName:"a"},"RoutingMessageHandler")," docs")),Object(i.b)("h3",{id:"14-initialize-networking"},"14. Initialize Networking"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," making peer connections, facilitating peer data to and from LDK"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"use lightning_net_tokio; // use LDK's sample networking module\n\nlet listen_port = 9735;\nlet listener = tokio::net::TcpListener::bind(format!(\"0.0.0.0:{}\", listen_port))\n    .await.unwrap()\nloop {\n    let tcp_stream = listener.accept().await.unwrap().0;\n    tokio::spawn(async move {\n        // Use LDK's supplied networking battery to facilitate inbound\n        // connections.\n        lightning_net_tokio::setup_inbound(\n            &peer_manager,\n            tcp_stream.into_std().unwrap(),\n        )\n        .await;\n    });\n}\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("inlineCode",{parentName:"p"},"PeerManager")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning-net-tokio/0.0.14/lightning_net_tokio/"}),"Rust ",Object(i.b)("inlineCode",{parentName:"a"},"lightning-net-tokio")," sample networking module")),Object(i.b)("h2",{id:"running-ldk"},"Running LDK"),Object(i.b)("p",null,"This section assumes you've already run all the steps in ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"#setup"}),"Setup"),"."),Object(i.b)("h3",{id:"15-keep-ldk-up-to-date-with-chain-info"},"15. Keep LDK Up-to-date with Chain Info"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," LDK needs to know when blocks are newly connected and disconnected and when relevant transactions are confirmed and/or reorged out."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)(o.a,{defaultValue:"bitcoind",values:[{label:"Bitcoind",value:"bitcoind"},{label:"Electrum",value:"electrum"}],mdxType:"Tabs"},Object(i.b)(l.a,{value:"bitcoind",mdxType:"TabItem"},Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"// If you don't have the chain tip, retrieve it here.\nif chain_tip.is_none() {\n    chain_tip = Some(\n        init::validate_best_block_header(&mut block_source).await.unwrap()\n    );\n}\n\n// Use your BlockSource from Step 10.\nlet chain_poller = poll::ChainPoller::new(&mut block_source, Network::Testnet);\nlet chain_listener = (chain_monitor, channel_manager);\nlet mut spv_client = SpvClient::new(\n    chain_tip.unwrap(),\n    chain_poller,\n    &mut cache,\n    &chain_listener,\n);\nloop {\n    // `poll_best_tip` will update ChannelManager and ChainMonitor with the\n    // best chain tip as needed.\n    spv_client.poll_best_tip().await.unwrap();\n    tokio::time::sleep(Duration::from_secs(1)).await;\n}\n"))),Object(i.b)(l.a,{value:"electrum",mdxType:"TabItem"},Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"/* UNCONFIRMED TRANSACTIONS */\n\n// Retrieve transaction IDs to check the chain for un-confirmation.\nlet relevant_txids_1 = channel_manager.get_relevant_txids();\nlet relevant_txids_2 = chain_monitor.get_relevant_txids();\n\n// If any txids `relevant_txids_*` gets reorged out, you must call:\nchannel_manager.transaction_unconfirmed(unconfirmed_txid);\nchain_monitor.transaction_unconfirmed(unconfirmed_txid);\n\n/* CONFIRMED TRANSACTIONS */\n\n// Retrieve transactions and outputs to check the chain for confirmation.\n// These should've been given to you for monitoring via the `Filter` interface.\n\n// If any transactions or output spends appear on-chain, you must call:\nchannel_manager.transactions_confirmed(header, height, confirmed_txs_list);\nchain_monitor.transactions_confirmed(header, height, confirmed_txs_list);\n\n/* CONNECTED OR DISCONNECTED BLOCKS */\n\n// Whenever there's a new chain tip or a block has been newly disconnected, you\n// must call:\nchannel_manager.update_best_block(new_best_header, new_best_height);\nchain_monitor.update_best_block(new_best_header, new_best_height);\n")))),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Implementation notes:")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"If you're using the ",Object(i.b)("inlineCode",{parentName:"li"},"Listen")," interface: blocks must be connected and disconnected in chain order"),Object(i.b)("li",{parentName:"ul"},"If you're using the ",Object(i.b)("inlineCode",{parentName:"li"},"Confirm")," interface: it's important to read the ",Object(i.b)("inlineCode",{parentName:"li"},"Confirm")," docs linked in References, to make sure you satisfy the interface's requirements")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelManager"),", ",Object(i.b)("inlineCode",{parentName:"p"},"ChainMonitor")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/chain/trait.Listen.html"}),"Rust ",Object(i.b)("inlineCode",{parentName:"a"},"Listen")," docs"),", ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/chain/trait.Confirm.html"}),"Rust ",Object(i.b)("inlineCode",{parentName:"a"},"Confirm")," docs")),Object(i.b)("h3",{id:"16-initialize-ldk-eventhandler"},"16. Initialize LDK ",Object(i.b)("inlineCode",{parentName:"h3"},"EventHandler")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," LDK generates events that must be handled by you, such as telling you when a payment has been successfully received or when a funding transaction is ready for broadcast."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")," from the LDK Rust sample node, of handling these events: ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/lightningdevkit/ldk-sample/blob/bc07db6ca4a3323d8718a27f85182b8157a20750/src/main.rs#L101-L240"}),"https://github.com/lightningdevkit/ldk-sample/blob/bc07db6ca4a3323d8718a27f85182b8157a20750/src/main.rs#L101-L240")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"// In this example, we provide a closure to handle events. But you're also free\n// to provide an implementation of the trait `EventHandler` instead.\n\n// This handler will be used in Step 18.\nlet handle_event_callback = move |event| {\n    handle_ldk_event(&channel_manager, &keys_manager, event)\n};\n\nfn handle_ldk_event(..) {\n    match event {\n        Event::FundingGenerationReady { .. } => { .. }, // insert handling code\n        Event::PaymentReceived { .. } => { .. }, // insert handling code\n        Event::PaymentSent { .. } => { .. }, // insert handling code\n        Event::PaymentPathFailed { .. } => { .. }, // insert handling code\n        Event::PendingHTLCsForwardable { .. } => { .. }, // insert handling code\n        Event::SpendableOutputs { .. } => { .. } // insert handling code\n        Event::PaymentForwarded { .. } => { .. } // insert handling code\n        Event::ChannelClosed { .. } => { .. } // insert handling code\n    }\n}\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Implementation notes:")," "),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"It's important to read the documentation for individual event handling (linked in References below) to make sure event handling requirements are satisfied"),Object(i.b)("li",{parentName:"ul"},"It is recommended to read through event handling in the LDK sample node (linked in the first example) to get an idea of what integrated LDK event handling looks like")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelManager"),", ",Object(i.b)("inlineCode",{parentName:"p"},"ChainMonitor"),", ",Object(i.b)("inlineCode",{parentName:"p"},"KeysManager"),", ",Object(i.b)("inlineCode",{parentName:"p"},"BroadcasterInterface")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/util/events/enum.Event.html"}),Object(i.b)("inlineCode",{parentName:"a"},"Event")," docs"),", ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/lightningdevkit/ldk-sample/blob/bc07db6ca4a3323d8718a27f85182b8157a20750/src/main.rs#L101-L240"}),"LDK sample node event handling example"),", ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/util/events/trait.EventHandler.html"}),Object(i.b)("inlineCode",{parentName:"a"},"EventHandler")," docs")),Object(i.b)("h3",{id:"17-initialize-the-channelmanagerpersister"},"17. Initialize the ",Object(i.b)("inlineCode",{parentName:"h3"},"ChannelManagerPersister")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," keeping ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelManager"),"'s stored state up-to-date"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"// In this example, we provide a closure to handle ChannelManager persistence.\n// But you're also free to provide an implementation of the trait \n// `ChannelManagerPersister` instead.\n\n// This callback will be used in the Step 18 for regular persistence.\nlet persist_channel_manager_callback = move |node: &ChannelManager| {\n    FilesystemPersister::persist_manager(ldk_data_dir, &*node)\n};\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Implementation notes:")," if the ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelManager")," is not persisted properly to disk, there is risk of channels force closing the next time LDK starts up. However, in this situation, no funds other than those used to pay force-closed channel fees are at risk of being lost."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelManager")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning-background-processor/*/lightning_background_processor/trait.ChannelManagerPersister.html"}),Object(i.b)("inlineCode",{parentName:"a"},"ChannelManagerPersister")," docs")),Object(i.b)("h3",{id:"18-start-background-processing"},"18. Start Background Processing"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," running tasks periodically in the background to keep LDK operational"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"let background_processor = BackgroundProcessor::start(\n    persist_channel_manager_callback,\n    handle_event_callback,\n    &chain_monitor,\n    &channel_manager,\n    &peer_manager,\n    &logger,\n);\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelManager"),", ",Object(i.b)("inlineCode",{parentName:"p"},"ChainMonitor"),", ",Object(i.b)("inlineCode",{parentName:"p"},"PeerManager"),", ",Object(i.b)("inlineCode",{parentName:"p"},"Logger")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning-background-processor/*/lightning_background_processor/struct.BackgroundProcessor.html#method.start"}),Object(i.b)("inlineCode",{parentName:"a"},"BackgroundProcessor::start")," docs")),Object(i.b)("h3",{id:"19-regularly-broadcast-node-announcement"},"19. Regularly Broadcast Node Announcement"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What it's used for:")," if you have 1 or more public channels, you may need to\nannounce your node and its channels occasionally. LDK will automatically\nannounce channels when they are created, but there are no guarantees you have\nconnected peers at that time or that your peers will propagate such announcements.\nThe broader node-announcement message is not automatically broadcast."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Example:")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-rust"}),"let mut interval = tokio::time::interval(Duration::from_secs(60));\nloop {\n    interval.tick().await;\n    channel_manager.broadcast_node_announcement(\n        [0; 3], // insert your node's RGB color\n        node_alias,\n        vec![ldk_announced_listen_addr],\n    );\n}\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Dependencies:")," ",Object(i.b)("inlineCode",{parentName:"p"},"ChannelManager")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"References:")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.rs/lightning/*/lightning/ln/channelmanager/struct.ChannelManager.html#method.broadcast_node_announcement"}),Object(i.b)("inlineCode",{parentName:"a"},"ChannelManager::broadcast_node_announcement")," docs")))}d.isMDXComponent=!0},86:function(e,n,t){"use strict";function a(e){var n,t,r="";if("string"==typeof e||"number"==typeof e)r+=e;else if("object"==typeof e)if(Array.isArray(e))for(n=0;n<e.length;n++)e[n]&&(t=a(e[n]))&&(r&&(r+=" "),r+=t);else for(n in e)e[n]&&(r&&(r+=" "),r+=n);return r}n.a=function(){for(var e,n,t=0,r="";t<arguments.length;)(e=arguments[t++])&&(n=a(e))&&(r&&(r+=" "),r+=n);return r}},88:function(e,n,t){"use strict";t.d(n,"a",(function(){return p})),t.d(n,"b",(function(){return m}));var a=t(0),r=t.n(a);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=r.a.createContext({}),b=function(e){var n=r.a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},p=function(e){var n=b(e.components);return r.a.createElement(s.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.a.createElement(r.a.Fragment,{},n)}},h=r.a.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),p=b(t),h=a,m=p["".concat(o,".").concat(h)]||p[h]||d[h]||i;return t?r.a.createElement(m,l(l({ref:n},s),{},{components:t})):r.a.createElement(m,l({ref:n},s))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,o=new Array(i);o[0]=h;var l={};for(var c in n)hasOwnProperty.call(n,c)&&(l[c]=n[c]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var s=2;s<i;s++)o[s]=t[s];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,t)}h.displayName="MDXCreateElement"},91:function(e,n,t){"use strict";var a=t(0),r=t(92);n.a=function(){const e=Object(a.useContext)(r.a);if(null==e)throw new Error("`useUserPreferencesContext` is used outside of `Layout` Component.");return e}},92:function(e,n,t){"use strict";var a=t(0);const r=Object(a.createContext)(void 0);n.a=r},96:function(e,n,t){"use strict";var a=t(0),r=t.n(a),i=t(91),o=t(86),l=t(53),c=t.n(l);const s=37,b=39;n.a=function(e){const{lazy:n,block:t,defaultValue:l,values:p,groupId:d,className:h}=e,{tabGroupChoices:m,setTabGroupChoices:u}=Object(i.a)(),[g,O]=Object(a.useState)(l),j=a.Children.toArray(e.children);if(null!=d){const e=m[d];null!=e&&e!==g&&p.some((n=>n.value===e))&&O(e)}const f=e=>{O(e),null!=d&&u(d,e)},_=[];return r.a.createElement("div",null,r.a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:Object(o.a)("tabs",{"tabs--block":t},h)},p.map((({value:e,label:n})=>r.a.createElement("li",{role:"tab",tabIndex:0,"aria-selected":g===e,className:Object(o.a)("tabs__item",c.a.tabItem,{"tabs__item--active":g===e}),key:e,ref:e=>_.push(e),onKeyDown:e=>{((e,n,t)=>{switch(t.keyCode){case b:((e,n)=>{const t=e.indexOf(n)+1;e[t]?e[t].focus():e[0].focus()})(e,n);break;case s:((e,n)=>{const t=e.indexOf(n)-1;e[t]?e[t].focus():e[e.length-1].focus()})(e,n)}})(_,e.target,e)},onFocus:()=>f(e),onClick:()=>{f(e)}},n)))),n?Object(a.cloneElement)(j.filter((e=>e.props.value===g))[0],{className:"margin-vert--md"}):r.a.createElement("div",{className:"margin-vert--md"},j.map(((e,n)=>Object(a.cloneElement)(e,{key:n,hidden:e.props.value!==g})))))}},97:function(e,n,t){"use strict";var a=t(3),r=t(0),i=t.n(r);n.a=function({children:e,hidden:n,className:t}){return i.a.createElement("div",Object(a.a)({role:"tabpanel"},{hidden:n,className:t}),e)}}}]);